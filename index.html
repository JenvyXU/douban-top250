<!DOCTYPE html>
<html lang="zh-Hans">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1198990_39uh8tina4n.css">
  <link rel="stylesheet" href="./userBoard.css">
  <link rel="stylesheet" href="./common.css">
  <link rel="stylesheet" href="./search.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <title>GithubTop仓库</title>
  <style>
    .item {
      border-bottom: 1px solid #ccc;
      padding-bottom: 10px;
      padding-top: 10px;
    }
    .item .cover{
      margin: 0 4px;
    }
    .item .cover,
    .item .cover img {
      width: 50px;
      border-radius: 4px;
      vertical-align: middle;
    }

    .item>a {
      display: flex;
    }

    .item .order {
      display: flex;
      align-items: center;
    }

    .item .order span {
      display: inline-block;
      text-align: center;
      min-width: 16px;
      padding: 1px 4px;
      color: #fff;
      background: green;
    }

    .item .detail {
      padding: 0 10px;
      flex-grow: 1;
    }

    .item .detail h2 {
      font-size: 16px;
      margin-bottom: 4px;
    }

    .item .detail .extra {
      color: #999;
      margin-top: 4px;
    }

    .item .detail .extra {
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    .item .detail .star-count {
      margin-left: 4px;
    }

    .item .detail .icon-star {
      color: #EEE170;
    }

    .loading {
      text-align: center;
      padding: 10px;
      display: none;
    }

    @keyframes rotate {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    .loading .iconfont {
      display: inline-block;
      animation: 1s rotate linear infinite;
    }

    #userBoard .item{
      display: flex;
    }

  </style>
</head>

<body>
  <main>
    <section id="repoBoard">
      <div class="container"></div>
      <div class="loading"><span class="iconfont icon-loading"></span></div>
    </section>
    <section id="userBoard">
      <div class="container"></div>
      <div class="loading"><span class="iconfont icon-loading"></span></div>
    </section>
    <section id="search">
      <div class="search-area">
        <input type="text" placeholder="Search Repo"><span class="button">Search</span>
      </div>
      <div class="search-result">
        <div class="loading"><span class="iconfont icon-loading"></span></div>
      </div>
    </section>
  </main>
  <footer>
    <div><span class="iconfont icon-top250"></span><span>Top Repos</span></div>
    <div class="active"><span class="iconfont icon-us"></span><span>Top Users</span></div>
    <div><span class="iconfont icon-search"></span><span>Search</span></div>
  </footer>

</body>

<script>

  var helpers = {

  }
  var repoBoard = {
    init: function () {
      this.$element = $('#repoBoard')
      this.page = 1
      this.count = 30
      this.isLoading = false
      this.isFinish = false
      this.bind()
      this.start()
    },
    bind: function () {
      var _this = this
      var clock
      this.$element.scroll(function () {
        if (clock) {//函数节流
          clearTimeout(clock)
        }
        clock = setTimeout(function () {
          //判断页面是否滚动到底部
          if (_this.isToBottom()) {
            _this.start()
          }
        }, 300)
      })
    },
    start: function () {
      var _this = this
      this.getData(function (data) {
        _this.renderData(data)
      })
    },
    getData: function (callback) {
      var _this = this
      if (_this.isLoading) return
      _this.isLoading = true
      _this.$element.find('.loading').show()
      $.ajax({
        url: 'https://api.github.com/search/repositories?q=language:javascript&sort=stars&order=desc',
        data: {
          page: _this.page
        },
        dataType: 'jsonp'
      }).done(function (ret) {

        if (_this.page >= ret.total) {
          _this.isFinish = true
        }
        callback && callback(ret)
        _this.page++
      }).fail(function () {
        console.log('数据异常')
      }).always(function () {
        _this.isLoading = false
        _this.$element.find('.loading').hide()
      })
    },
    createNode: function (subject, index) {
      var tpl = `
        <div class="item">
          <a href="https://github.com/TryGhost/Ghost">
            <div class="order"><span>1</span></div>
            <div class="detail">
              <h2>Ghost</h2>
              <div class="description">Knockout makes it easier to create rich, responsive UIs with JavaScript</div>
              <div class="extra"><span class="iconfont icon-star"></span><span class="star-count">4196</span></div>  
           </div>
         </a>
        </div> `
      var $node = $(tpl)
      $node.find('.order span').text(index)
      $node.find('a').attr('href', subject.html_url)
      $node.find('.detail h2').text(subject.name)
      $node.find('.detail .description').text(subject.description)
      $node.find('.detail .collection').text(this.toThousand(subject.collect_count))
      $node.find('.detail .star-count').text(this.toThousand(subject.stargazers_count))
      return $node
    },
    renderData: function (data) {
      var _this = this
      data.data.items.forEach(function (item, index) {
        var $node = _this.createNode(item, (_this.page - 1) * _this.count + index + 1)
        _this.$element.find('.container').append($node)
      })
    },
    toThousand: function (num) { //123456 => 123.4k
      if (num <= 1000) return
      var bigNum = Math.floor(num / 1000)
      var smallNum = String(num % 1000).substr(0, 1)
      return bigNum + '.' + smallNum + 'k'
    },
    isToBottom: function () {
      return this.$element.find('.container').height() <= this.$element.height() + this.$element.scrollTop() + 20
    }
  }
  var userBoard = {
    init: function () {
      this.$element = $('#userBoard')
      this.page = 1
      this.count = 30
      this.isFinish = false
      this.isLoading = false
      this.start()
      this.bind()
    },
    start: function () {
      var _this = this
      this.getData(function (data) {
        _this.renderData(data)
      })
    },
    bind: function () {
      var _this = this
      var clock
      this.$element.scroll(function () {
        console.log(1)
        if (clock) {//函数节流
          clearTimeout(clock)
        }
        clock = setTimeout(function () {
          //判断页面是否滚动到底部
          if (_this.isToBottom()) {
            _this.start()
          }
        }, 300)
      })
    },
    isToBottom: function () {
      return this.$element.find('.container').height() <= this.$element.height() + this.$element.scrollTop() + 20
    },
    getData: function (callback) {
      var _this = this
      if (_this.isLoading) return
      _this.isLoading = true
      _this.$element.find('.loading').show()
      $.ajax({
        url: 'https://api.github.com/search/users?q=followers:>1000+location:china+language:javascript',
        data: { page: this.page },
        ///https://api.github.com/search/users?q=ruanyf in:login
        dataType: 'jsonp'
      }).done(function (ret) {
        if (_this.index >= ret.total) {
          _this.isFinish = true
        }
        callback && callback(ret)
        _this.page++
        _this.isLoading = false
      }).fail(function () {
        console.log('数据异常')
      }).always(function () {
        _this.$element.find('.loading').hide()
      })
    },
    renderData(data) {
      var _this = this
      data.data.items.forEach(function (item, index) {
        var $node = _this.createNode(item, (_this.page - 1) * _this.count + index + 1)
        _this.$element.find('.container').append($node)
      })
    },
    createNode: function (subject, index) {
      var $node = $(`<div class="item">
          <a href="https://github.com/TryGhost/Ghost">
            <div class="cover"><img src="" alt=""></div>
            <div class="detail">
            <h2>Ghost</h2>
          </a>
        </div> `)
      $node.find('.cover img').attr('src', subject.avatar_url)
      $node.find('a').attr('href', subject.html_url)
      $node.find('.detail h2').text(subject.login)
      return $node
    }
  }
  var search = {
    init: function () {
      this.$element = $('#search')
      this.$content = this.$element.find('.container')
      this.page = 1
      this.count = 30
      this.isLoading = false
      this.isFinish = false
      this.bind()
    },
    bind: function () {
      var _this = this
      var clock
      this.$element.scroll(function () {
        if (clock) {//函数节流
          clearTimeout(clock)
        }
        clock = setTimeout(function () {
          //判断页面是否滚动到底部
          if (_this.isToBottom()) {
            _this.start()
          }
        }, 300)
      })
      this.$element.find('.search-area .button').on('click', function () {
        _this.getData(function (result) {
          console.log(result.data)
          _this.renderData(result.data)
        })
      })
    },

    getData: function (callback) {
      var _this = this
      var keyword = this.$element.find('.search-area input').val()
      console.log(keyword)
      if (_this.isLoading) return
      _this.isLoading = true
      _this.$element.find('.loading').show()
      $.ajax({
        url: `https://api.github.com/search/repositories?q=${keyword}+language:javascript&sort=stars&order=desc&page=${_this.page}`,
        dataType: 'jsonp'
      }).done(function (ret) {
        if (_this.page >= ret.total) {
          _this.isFinish = true
        }
        console.log(ret)
        callback && callback(ret)
        _this.page++
      }).fail(function () {
        console.log('数据异常')
      }).always(function () {
        _this.isLoading = false
        _this.$element.find('.loading').hide()
      })
    },
    createNode: function (subject, index) {
      var tpl = `
        <div class="item">
          <a href="https://github.com/TryGhost/Ghost">
            <div class="order"><span>1</span></div>
            <div class="detail">
              <h2>Ghost</h2>
              <div class="description">Knockout makes it easier to create rich, responsive UIs with JavaScript</div>
              <div class="extra"><span class="iconfont icon-star"></span><span class="star-count">4196</span></div>  
           </div>
         </a>
        </div> `
      var $node = $(tpl)
      $node.find('.order span').text(index)
      $node.find('a').attr('href', subject.html_url)
      $node.find('.detail h2').text(subject.name)
      $node.find('.detail .description').text(subject.description)
      $node.find('.detail .collection').text(this.toThousand(subject.collect_count))
      $node.find('.detail .star-count').text(this.toThousand(subject.stargazers_count))
      return $node
    },
    renderData: function (data) {
      var _this = this
      data.items.forEach(function (item, index) {
        var $node = _this.createNode(item, (_this.page - 1) * _this.count + index + 1)
        _this.$element.find('.search-result').append($node)
      })
    },
    toThousand: function (num) { //123456 => 123.4k
      if (num <= 1000) return
      var bigNum = Math.floor(num / 1000)
      var smallNum = String(num % 1000).substr(0, 1)
      return bigNum + '.' + smallNum + 'k'
    },
    isToBottom: function () {
      return this.$element.find('.container').height() <= this.$element.height() + this.$element.scrollTop() + 20
    }
  }

  var app = {
    init: function () {
      this.$tabs = $('footer>div')
      this.$panels = $('section')
      this.bind()

      repoBoard.init()
      userBoard.init()
      search.init()

    },
    bind: function () {
      var _this = this
      this.$tabs.on('click', function () {
        $(this).addClass('active').siblings().removeClass('active')
        _this.$panels.eq($(this).index()).fadeIn().siblings().hide()
      })
    }
  }
  app.init()

</script>

</html>